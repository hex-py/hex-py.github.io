---
layout:     post
title:      Ansible 使用记录
subtitle:   简记 Ansible使用.
date:       2019-12-13
author:     Hex
header-img: img/post-bg-iWatch.jpg
catalog: true
tags:
    - Ansible
    - 运维笔记
    - Python
---

#### 1. ubuntu 18.04 install Ansible

`software-properties-common` package installed. This software will make it easier to manage this and other independent software repositories:
```bash
apt update
apt install software-properties-common
```

Then add the Ansible PPA by typing the following command:
```bash
apt-add-repository ppa:ansible/ansible
```

install Ansible
```bash
apt update
apt install ansible
```

#### 2. config ssh access to ansible-hosts


#### 3. ansible 注意

1. ansible 主机需要安装 pip install netaddr，因为 playbook 依赖
2. ansible 主机需要安装 apt install sshpass ，因为使用密码连接
3. ansible 主机需要安装 apt install zip unzip 因为 playbook 需要解压文件
4. ansible 主机需要配置 ansible 的`host_key_checking`(/etc/ansible/ansible.cfg)为`False`，因为所有主机都是第一次连接，还没有主机指纹在`known_hosts`中，需要忽略

#### 4. 测试Ansible-Hosts连通性方法
1. `vi /etc/ansible/hosts`追加以下内容，IP地址即为要测试的机器
```ini
[test]
10.8.2.95 ansible_ssh_user=root ansible_ssh_pass=Qloud@123 docker_registry=true
```
2. 执行以下命令，用`ping`模块进行测试。`test`为上面为hosts配置的主机组名字。
```bash
ansible -i /etc/ansible/hosts test -m ping
```

#### 4. Ansible 的一些约定

1. inventory 主机清单
    `-i`参数指定主机清单。例如`ansible-playbook -i inventory.py nomad.yaml`
   
   1.1 静态inventory，通过静态配置文件`inventory.json`配置。
   
   1.2 动态inventory，通过动态生成脚本`inventory.py`生成。

2. roles目录必须与playbook文件同级，并且文件夹名必须为`roles`。playbook文件中通过`roles`下的各个文件夹名字引用role
    例如 
    ```yaml
    - name: install mirrors and initialization         
      hosts: all                                       
      roles:                                           # roles/
        - yum-mirrors                                  #   |-- yum-mirrors/
        - initialization                               #   |-- initializations/
        - docker-registry                              #   |-- docker-registry/
    ```

3. 单个role目录结构说明。
    ```yaml
    .
    ├── install_nginx.yml              # playbook 文件和 roles 目录应该处于平级目录
    └── roles                          # 存放所有角色的的目录
        └── nginx                      # nginx 角色
        │   ├── defaults               # 设定默认变量
        │   │   └── main.yml
        │   ├── files                  # 存放由 copy 或 script 模块等调用的文件
        │   │   └── index.html
        │   ├── handlers               # 触发器任务
        │   │   └── main.yml
        │   ├── meta                   # 定义当前角色的特殊设定及其依赖关系
        │   ├── tasks                  # 定义任务，它是 role 的基本元素
        │   │   └── main.yml
        │   ├── templates              # templates 模块查找所需要模板文件的目录
        │   │   └── nginx.conf.j2
        │   └── vars                   # 定义变量
        │       └── main.yml
        └── php                        # php 角色
            └── ...
    ```

4. playbook文件的定义中，优先级: `role` > `task`; 如果`task-A`必须要在某`role-B`之前执行，需要将`task-A`封装为`role-A`，放到`role-B`之前。

5. `task`中常用的模块
    
    |  模块名称      |      作用                                                                |
    |---------------|-------------------------------------------------------------------------|
    |  ping	        | 检查指定节点机器是否还能连通                                                |
    |  command	    | 执行命令模块，可以不填，是ansible默认的模块，命令中无法使用变量，管道。          |
    |  shell	    | 启动一个子shell执行命令，执行的命令中有管道或者变量，就需要使用shell模块。       |
    |  script	    | 将本机的shell脚本在被管理主机运行                                           |
    |  copy	        | 将本机复制文件到远程位置                                                   |
    |  service	    | 用于控制远程主机的服务                                                     |
    |  cron	        | 用于管理定时任务                                                          |
    |  file	        | 用于远程主机上的文件操作                                                   |
    |  yum	        | 使用yum包管理器来管理软件包                                                |
    |  user、group	| user、goup分别请求：useradd、userdel、usermod；groupadd、groupdel、groupmod|
    |  filesystem	| 在块设备上创建文件系统                                                     |
    |  get_url	    | 下载文件                                                                 |
    |  synchronize	| 同步文件模块                                                              |
 
 
 
#### Reference

[Install Ansible on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-18-04)

[官方文档](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
[中文文档](https://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html)

[ansible Ad-Hoc命令集](https://blog.csdn.net/yongchaocsdn/article/details/78750469)

[金恒博客](https://yangjinheng.github.io/2017/03/20/Linux/Ansible/)