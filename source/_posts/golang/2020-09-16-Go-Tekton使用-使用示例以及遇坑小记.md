---
title: Go-Tekton使用-使用示例以及遇坑小记
categories:
  - Golang
tags:
  - Go
date: '2020-09-16 09:17:15'
top: false
comments: true
---

# 重要

打算依托Tekton,作为工作流工具，将以下业务场景用task实现：

1. 镜像部署
2. 源码构建+镜像部署
3. 源码文件上传hdfs
4. 微服务依赖关系

# 环境说明

k8s集群： 

# 安装

Tekton安装，通过官方GitHub仓库中的release.yaml文件部署服务。

```bash
kubectl apply -f https://github.com/tektoncd/pipeline/releases/download/v0.16./release.yaml
```



# 使用
需要检查这几项, workspace

# Reference
[官方文档入口-select-version](https://github.com/tektoncd/pipeline#read-the-docs)

##  nuctl
> nuctl 是`nuclio`的客户端, nuctl使用时需要访问docker-daemon, 
```bash
$ nuctl get project --verbose
20.10.20 16:53:48.316            nuctl.platform (D) Using kubeconfig {"kubeconfigPath": "/home/hex/.kube/config"}
20.10.20 16:53:48.324 tl.platform.docker.runner (D) Executing {"command": "docker version"}
20.10.20 16:53:48.388 tl.platform.docker.runner (D) Command executed successfully {"output": "Client: Docker Engine - Community\n Version:           19.03.4\n API version:       1.40\n Go version:        go1.12.10\n Git commit:        9013bf583a\n Built:             Fri Oct 18 15:54:09 2019\n OS/Arch:           linux/amd64\n Experimental:      false\n\nServer: Docker Engine - Community\n Engine:\n  Version:          19.03.4\n  API version:      1.40 (minimum version 1.12)\n  Go version:       go1.12.10\n  Git commit:       9013bf583a\n  Built:            Fri Oct 18 15:52:40 2019\n  OS/Arch:          linux/amd64\n  Experimental:     false\n containerd:\n  Version:          1.2.10\n  GitCommit:        b34a5c8af56e510852c35414db4c1f4fa6172339\n runc:\n  Version:          1.0.0-rc8+dev\n  GitCommit:        3e425f80a8c931f88e6d94a8c831b9d5aa481657\n docker-init:\n  Version:          0.18.0\n  GitCommit:        fec3683\n", "stderr": "", "exitCode": 0}
```
所以需要创建`docker-in-docker`的服务
[task docker-in-docker](https://github.com/tektoncd/pipeline/blob/master/examples/v1beta1/taskruns/dind-sidecar.yaml)
[dind issue](https://github.com/tektoncd/pipeline/issues/1929)

## 构建镜像(kaniko)
[task kaniko](https://hub-preview.tekton.dev/detail/55)

## `task`之间传递数据(通过 result 配置)
[传出result](https://github.com/tektoncd/pipeline/blob/master/docs/tasks.md#emitting-results)
[传出result -- task级别](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#configuring-execution-results-at-the-task-level)
[传出result -- pipe级别](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#configuring-execution-results-at-the-pipeline-level)

[传入result -- task级别](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#passing-one-tasks-results-into-the-parameters-or-whenexpressions-of-another)

## 使用`when`做任务编排
[任务编排 -- when](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#guard-task-execution-using-whenexpressions)

## 使用`runAfter`做任务编排
[任务编排 -- runAfter](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#using-the-runafter-parameter)

## workspace 
[工作空间使用](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#specifying-workspaces)

## auth
[Authorization at RunTime](https://github.com/tektoncd/pipeline/blob/master/docs/auth.md)
