---
title: PKI-自签发证书说明
categories:
  - Devops
tags:
  - Devops
  - 证书
date: '2020-07-08 09:16:33'
top: false
comments: true
---

# 重要

# 生成自签发证书
1. 生成CA根证书以及根证书私钥.
> output: `ca.crt`和 `ca.key`, pem格式. input ''
```bash
# Generate a CA private key
openssl genrsa -out ca.key 4096

# Create a self signed Certificate, valid for 10yrs with the 'signing' option set
openssl req -x509 -new -nodes -key ca.key -subj "/CN=QLOUDFIN.COM" -days 3650 -reqexts v3_req -extensions v3_ca -out ca.crt
```

2. 生成`*.service.consul`通配符证书私钥 
> output: `service.consul.key`, pem格式. input: ''
```bash
openssl genrsa -out service.consul.key 4096
```

3. 根据`*.service.consul`通配符证书私钥，生成证书请求文件(csr)`service.consul.csr` 
> output: `service.consul.csr`, pem格式. input: `service.consul.key`.
```bash
openssl req -new -sha256 -key service.consul.key -out service.consul.csr -subj "/CN=obp-qmspdp-service-pditdap.service.consul"
```

4. 根据证书请求文件通过根证书、根证书私钥签发证书。
> output: `service.consul.crt`, pem格式. input: `service.consul.csr`和`ca.crt`和`ca.key` 以及配置文件`service.consul.ini`.
其中，配置文件`service.consul.ini`的内容如下：
```ini
[ ext ]
subjectAltName = @dns

[ dns ]
DNS.1 = *.service.consul
```
执行下面命令：
```bash
openssl x509 -req -in service.consul.csr -CA ca.crt -CAkey ca.key -CAcreateserial -days 3560 -out service.consul.crt -extfile service.consul.ini -extensions ext
```

5. 生成k8s中的secret. 
> output: k8s-secret `ambassador-certs`, pem格式. input: `service.consul.crt` 和 `service.consul.key` pem格式.
```bash
kubectl create secret tls ambassador-certs --cert=service.consul.crt --key=service.consul.key
```
# Reference

[概念说明](https://www.cnblogs.com/guogangj/p/4118605.html)
[生成证书](https://blog.csdn.net/xiangyuecn/article/details/79179684)
