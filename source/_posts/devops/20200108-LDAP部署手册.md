---
title: LDAP部署手册
categories:
  - Devops
tags:
  - Devops
  - LDAP
  - Deployment
date: '2020-01-08 03:38:10'
top: false
comments: true
---

## 重点
> 1. DN 是一条LDAP记录项的名字，并作为唯一标识。可以理解成uuid，具体格式像： "cn=admin,dc=service,dc=corp"


## 一.概念
> 1. LDAP：Lightweight Directory Access Protocol，轻量目录访问协议。
> 2. LDAP服务是一个为只读（查询、浏览、搜索）访问而优化的非关系型数据库，呈树状结构组织数据。
> 3. LDAP主要用做用户信息查询（如邮箱、电话等）或对各种服务访问做后台认证以及用户数据权限管控。

名词解释：
> *DC*: domain component一般为公司名，例如：dc=163,dc=com
> *OU*: organization unit为组织单元，最多可以有四级，每级最长32个字符，可以为中文
> *CN*: common name为用户名或者服务器名，最长可以到80个字符，可以为中文
> *DN*: distinguished name为一条LDAP记录项的名字，有唯一性，例如：dc:"cn=admin,ou=developer,dc=163,dc=com"

图形示例: 

![image](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap8tkwmbcj30lq0cota9.jpg)

## 二.安装

#### docker 安装
> 1. [openldap官方镜像-Github](https://github.com/osixia/docker-openldap)
> 2. [ldap-account-manager Docker-hub](https://hub.docker.com/r/ldapaccountmanager/lam)

```bash
# 拉取镜像
docker pull osixia/openldap

# 启动容器
docker run \
       -p 389:389 \
       --name openldap \
       --restart=always \
       --env LDAP_ORGANISATION="sotemalltest" \
       --env LDAP_DOMAIN="sotemalltest.com" \
       --env LDAP_ADMIN_PASSWORD="redhat" \
       --detach osixia/openldap
```
说明：
+ 389端口：默认ldap服务是使用389端口
+ LDAP_ORGANISATION 表示ldap的机构组织
+ LDAP_DOMAIN 配置LDAP域
+ LDAP_ADMIN_PASSWORD 配置LDAP管理员(admin)的密码
+ 默认用登陆用户名admin

如果是Windows用户，建议使用ldapadmin， 这样就省去安装管理ldap的服务，如果使用Ubuntu，建议还是装一个管理服务，毕竟Ubuntu下的管理ldap工具都太原始了，还不如命令来的好用。

```bash
# 拉取ldap account manager镜像
docker pull ldapaccountmanager/lam

# 启动容器
docker run -d \
        --restart=always \
        --name ldap-account-manager \
        -p 80:80 \
        --link openldap:ldap-host \
        --env PHPLDAPADMIN_LDAP_HOSTS=ldap-host \
        --env PHPLDAPADMIN_HTTPS=false \
        --detach ldapaccountmanager/lam
```
说明：
+ `--link`这里连接到OpenLDAP容器并起了一个别名ldap-host
+ `PHPLDAPADMIN_LDAP_HOSTS`这里直接通过别名指向OpenLDAP容器，这样不需要写死IP地址
+ `PHPLDAPADMIN_HTTPS`不使用443协议
+ `--restart=always`加入此参数是防止系统重启了容器未启动。(docker服务开机启动)

#### Kubernetes 安装
获取chart: 
> github地址: `https://github.com/helm/charts.git`
> 文件路径:  `charts`-`stable`-`openldap`

```bash
helm install --name=openldap openldap
```
具体详细配置，参考该chart readme文件。

## 三.使用

#### Docker 版使用

访问ldap-account-manager,打开网页访问： `http://IP`

![ldap-deploy-1](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap5av7hyrj30wq0dvq3m.jpg)

点击上图3号位置，配置lam。如下图所示，点击`Edit server profiles`

![ldap-deploy-2](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap5eeob7gj30dz0avq31.jpg)

提示输入Lam密码，默认密码`lam`，可自行修改。登录后如下图做相应修改:

![ldap-deploy-3](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap5gqaj6wj30v90ctq3m.jpg)

修改一下默认的管理员帐号：

![ldap-deploy-4](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap5id6z1vj30s004raa0.jpg)

接下来是修改默认创建的两个组，这两个会在首次登陆系统时提示创建

![ldap-deploy-5](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap5jfeqb2j30s10c1gm6.jpg)

保存后，登陆系统

![ldap-deploy-6](https://tvax3.sinaimg.cn/large/006hT4w1ly1gap5k8ga2fj30gk0am74f.jpg)

提示创建默认的组:

![ldap-deploy-7](https://tvax2.sinaimg.cn/large/006hT4w1ly1gap5l7uumvj30o507tmx8.jpg)

![ldap-group+user](https://tva3.sinaimg.cn/large/006hT4w1ly1gap61auymhj30bk0bejrk.jpg)

lam详细使用 参考博客[ldap account manager 使用](https://www.58jb.com/html/use-ldap-account-manager.html)

## Reference

[运维吧-ldap1-openldap部署及管理维护](https://mp.weixin.qq.com/s/JyH5mqwWFt0N1nGYZqBCBQ)
[运维吧-ldap2-SVN集成openldap](https://www.cnblogs.com/37Y37/p/9321458.html)
[运维吧-ldap3-GitLab集成OpenLDAP认证](https://www.cnblogs.com/37Y37/p/9335034.html)
[运维吧-ldap4-Jenkins集成OpenLDAP认证](https://www.cnblogs.com/37Y37/p/9430272.html)

[ldap-jenkins](https://www.cnblogs.com/zhaojiedi1992/p/zhaojiedi_liunx_52_ldap_for_jenkins.html)
[ldap-grafana](https://www.cnblogs.com/zhaojiedi1992/p/zhaojiedi_liunx_51_ldap_for_grafana.html)
[lam 使用说明](https://www.58jb.com/html/use-ldap-account-manager.html)